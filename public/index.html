<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>B2B_Messenger</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
    <link rel="stylesheet" href="css/custom.css">
  </head>
  <body>
    <!-- header Top 영역 -->
    <header class="navbar-fixed">
        <nav>
            <div class="nav-wrapper valign-wrapper">
                <a href="#" id="aBackBtn" class="small material-icons left hiddendiv">arrow_back</a>
                <span id="spTitle" class="brand-logo center">B2B_Messenger</span>
                <a href="#dvAddUser" id="aInvite" class="small material-icons right hiddendiv modal-trigger">add</a>
            </div>
        </nav>
    </header>
    <!-- main 컨텐츠 영역 -->
    <main>
        <!-- 유저리스트탭 영역 -->
        <div id="tab-1" class="col s12 tabContents">
            <ul id="ulUserList" class="collection">
            </ul>
        </div>
        <!-- 채팅방리스트탭 영역 -->
        <div id="tab-2" class="col s12 tabContents" style="display: none">
            <ul id="ulRoomList" class="collection">
            </ul>
        </div>
        <!-- 설정탭 영역 -->
        <div id="tab-3" class="col s12 tabContents">
            <ul class="collection">
                <li id="liLogOut" class="collection-item">로그아웃</li>
                <li id="liAddUser" class="collection-item" style="display:none;">신규입사자 등록</li>
                <li id="liPartChange" class="collection-item" style="display:none;">부서이동</li>
                <li id="liDeleteUser" class="collection-item" style="display:none;">퇴사자 제거</li>
            </ul>
        </div>
        <!-- 채팅방 메세지화면 영역 -->
        <div id="tab-4" class="col s12 tabContents ">
            <ul id="ulMessageList" class="collection">
            </ul>
            <div id="dvMsgForm" class="meta-bar chat">
                <div id="dvInputChat" contenteditable="true" placeholder="메세지 작성"></div>
                <i id='iBtnAttach' class="small material-icons">attach_file</i>
                <i id='iBtnSend' class="small material-icons">send</i>
                <input type="file" id="attachFile" style="display:none;"/>
            </div>
        </div>
    </main>
    <!-- footer 탭 영역 -->
    <footer>
        <ul id="tabs" class="tabs tabs-fixed-width">
            <li class="tab col s3 blue darken-2"><a id="tabUserList" href="#tab-1"><i class="small material-icons white-text">person</i></a></li>
            <li class="tab col s3 blue darken-2"><a id="tabRoomList" href="#tab-2"><i class="small material-icons white-text">message</i></a></li>
            <li class="tab col s3 blue darken-2"><a id="tabSetting" href="#tab-3"><i class="small material-icons white-text">settings</i></a></li>
            <li class="tab col s3" style="display:none"><a id="tabMessageList" href="#tab-4"></a></li>
        </ul>
    </footer>
    <!-- 로그인 화면 및 가입화면 영역 -->
    <div id="dvAuth">
      <div id="dvLogin">
          <h5>로그인</h5>
          <div id="dvEmail">
              <input type="email" id="userName" name="userName" class="input-text" placeholder="이메일 아이디">
              <input type="password" id="password" name="password" class="input-text" maxlength="17" placeholder="비밀번호">
              <ul class="btnGroup">
                  <li id="liEmailBtn" class="waves-effect waves-teal btn-flat">로그인</li>
              </ul>
              <ul class="btnGroup">
              	  <li id="liAdminEmailJoin" class="waves-effect waves-teal btn-flat">관리자 등록</li>
              </ul>
              <ul class="btnGroup">
                  <li id="liEmailJoin" class="waves-effect waves-teal btn-flat">회원가입</li>
              </ul>
          </div>
      </div>
      <div id="dvAdminJoin">
      	  <h5>관리자 등록</h5>
      	  <input type="text" id="joinAdminName" name="adminName" class="input-text" placeholder="이름">
      	  <div class="row" style="width: 100%!important; margin-bottom:0px!important">
      	  	<div class="col" style="width: 70%!important;"><input type="email" id="joinAdminEmail" name="adminName" class="input-text" placeholder="이메일 아이디"></div>
      	  	<div class="col"><a id="btnSendAdminCode" class="waves-effect waves-teal btn" style="height: 46px!important; line-height: 46px!important">관리자 코드 발송</a></div>
      	  </div>
      	  <span class="red-text"> * 관리자 코드는 관리팀 전용 이메일로만 발송됩니다.</span>
      	  <input type="password" id="joinAdminPassword" name="adminPassword" class="input-text" maxlength="17" placeholder="비밀번호">
      	  <input type="password" id="joinAdminRePassword" class="input-text" maxlength="17" placeholder="비밀번호 확인">
      	  <input type="text" id="joinAdminCode" class="input-text" placeholder="관리자 코드">
      	  <ul class="btnGroup">
      	  	  <li id="liAdminEmailJoinSubmit" class="waves-effect waves-teal btn-flat">등록하기</li>
      	  </ul>
      </div>
      <div id="dvJoin">
          <h5>사용자 등록</h5>
          <input type="text" id="joinUserName" name="userName" class="input-text" placeholder="이름">
          <input type="email" id="joinUserEmail" name="userName" class="input-text" placeholder="이메일 아이디">
          <input type="password" id="joinPassword" name="password" class="input-text" maxlength="17" placeholder="비밀번호">
          <input type="password" id="joinRePassword" class="input-text" maxlength="17" placeholder="비밀번호 확인">
          <ul class="btnGroup">
              <li id="liEmailJoinSubmit" class="waves-effect waves-teal btn-flat">등록하기</li>
          </ul>
      </div>
    </div>
    <!-- Modal 영역 -->
    <div id="dnModal" class="modal col s4">
        <div class="modal-content">
            <h5>업로드</h5>
            <div class="progress">
                <div id="dvProgressBar" class="determinate"></div>
                <div id="dvFileName"></div>
            </div>
        </div>
    </div>
    <div id="dvAddUser" class="modal">
        <div class="modal-content">
          <h5>초대</h5>
          <ul id="ulAddUserList" class="collection">
          </ul>
        </div>
        <div class="modal-footer">
            <a id="aConfirmInvite" href="#!" class="modal-action modal-close waves-effect waves-green btn blue white-text">추가</a>
        </div>
    </div>
    <!-- template 영역 -->
    <!-- template 유저리스트 영역 -->
    <script type="text/template" id="templateUserList">
            <li id="li<%=targetUserUid %>" data-targetUserUid="<%=targetUserUid %>" data-username="<%=userName %>" class="collection-item avatar list">
                <img src="<%=profileImg ? profileImg : 'img/noprofile.png'  %>" alt="" class="circle">
                <span class="title"><%=userName %></span>
                <span class="small material-icons right hiddendiv done">done</span>
                <span class="small material-icons right hiddendiv mood yellow-text">mood</span>
            </li>
    </script>
    <!-- template 메세지리스트 영역 -->
    <script type="text/template" id="templateMessageList">
        <li id="li<%=key%>" class="collection-item avatar" data-key="<%=key%>">
            <img src="<%=profileImg ? profileImg : 'img/noprofile.png'  %>" alt="" class="circle">
            <span class="title"><%=userName %></span><span class="time"><%=time %></span>
            <p><%=message %></p>
        </li>
    </script>
    <!-- template 채팅방리스트 영역 -->
    <script type="text/template" id="templateRoomList">
        <li id="liRoom<%=roomId %>" data-roomId="<%=roomId %>" data-roomTitle='<%=roomTitle%>' data-roomUserName="<%=roomUserName%>"
            data-roomType="<%=roomType%>" data-roomOneVSOneTarget="<%=roomOneVSOneTarget%>" data-roomUserlist="<%=roomUserlist %>" class="collection-item avatar" >
            <img src="<%=profileImg ? profileImg : 'img/noprofile.png'  %>" alt="" class="circle">
            <span class="title"><%=roomTitle%></span>
            <p><%=lastMessage %></p>
            <a href="#!" class="secondary-content"> <%=datetime %></a>
        </li>
    </script>
      <script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
      <script type="text/javascript" src="js/materialize.min.js"></script>
      <script type="text/javascript" src="js/underscore-min.js"></script>
      <script type="text/javascript" src="https://cdn.emailjs.com/sdk/2.3.2/email.min.js"></script>
      <!-- update the version number as needed -->
      <script defer src="/__/firebase/4.6.1/firebase-app.js"></script>
      <script defer src="/__/firebase/4.6.1/firebase-auth.js"></script>
      <script defer src="/__/firebase/4.6.1/firebase-database.js"></script>
      <script defer src="/__/firebase/4.6.1/firebase-messaging.js"></script>
      <script defer src="/__/firebase/4.6.1/firebase-storage.js"></script>
      <script defer src="/__/firebase/init.js"></script>
      <script>
          
          /* FirebaseChat ES5 클래스 */
          function FirebaseChat(){
          	this.init();
          	this.initEvent();
          }

          /* 초기 변수 할당 공간 */
          FirebaseChat.prototype.init = function() {
          	this.auth = firebase.auth();
          	this.liEmailJoin = document.getElementById('liEmailJoin');
          	this.liAdminEmailJoin = document.getElementById('liAdminEmailJoin');
          	this.btnSendAdminCode = document.getElementById('btnSendAdminCode');
          	this.liEmailJoinSubmit = document.getElementById('liEmailJoinSubmit');
          	this.liAdminEmailJoinSubmit = document.getElementById('liAdminEmailJoinSubmit');
          	this.liEmailBtn = document.getElementById('liEmailBtn');
          	this.dvLogin = document.getElementById('dvLogin');
          	this.dvJoin = document.getElementById('dvJoin');
          	this.dvAdminJoin = document.getElementById('dvAdminJoin');
          	this.dvAuth = document.getElementById('dvAuth');
          	this.liLogOut = document.getElementById('liLogOut');
          	this.ulUserList = document.getElementById('ulUserList');
          	this.tabMessageList = document.getElementById('tabMessageList');
          	this.aBackBtn = document.getElementById('aBackBtn');
          	this.aInvite = document.getElementById('aInvite');
          	this.spTitle = document.getElementById('spTitle');
          	this.ulMessageList = document.getElementById('ulMessageList');
          	this.dvInputChat = document.getElementById('dvInputChat');
          	this.iBtnSend = document.getElementById('iBtnSend');
          	this.ulRoomList = document.getElementById('ulRoomList');
          	this.ulAddUserList = document.getElementById('ulAddUserList');
          	this.aConfirmInvite = document.getElementById('aConfirmInvite');
          	this.iBtnAttach = document.getElementById('iBtnAttach');
          	this.attachFile = document.getElementById('attachFile');

          	// 채팅 방 관련 구분자
          	this.SPLIT_CHAR = "@spl@";
          	this.ONE_VS_ONE = "ONE_VS_ONE";
          	this.MULTI = "MULTI";
          	this.ORIGIN_TITLE = "B2B_Messenger";

          	// roomId를 생성하기 위한 구분자
          	this.MAKEID_CHAR = "@make@";
          	this.DATETIME_CHAR = "@time@";

          	// saveUserAtIndexedDB 메소드에서 사용할 상수
          	// 매번 Realtime DB에 접근하지 않고 Local에서 데이터 저장 여부를 확인
          	this.INDEXDB_DB_NAME = "USER";
          	this.INDEXDB_VERSION = 1;
          	this.INDEXDB_STORE = "Users";
          }

          /* Event binding */
          FirebaseChat.prototype.initEvent = function() {
          	this.auth.onAuthStateChanged(this.onAuthChange.bind(this));
          	this.liEmailJoin.addEventListener('click', this.displayEmailJoin.bind(this));
          	this.liAdminEmailJoin.addEventListener('click', this.displayAdminEmailJoin.bind(this));
          	this.btnSendAdminCode.addEventListener('click', this.sendAdminCode.bind(this));
          	this.liEmailJoinSubmit.addEventListener('click', this.createEmailUser.bind(this));
          	this.liAdminEmailJoinSubmit.addEventListener('click', this.createAdminEmailUser.bind(this));
          	this.liEmailBtn.addEventListener('click', this.onEmailBtnClick.bind(this));
          	this.liLogOut.addEventListener('click', this.logOut.bind(this));
          	this.dvInputChat.addEventListener('keydown', this.onEnterKey.bind(this));
          	this.dvInputChat.addEventListener('paste', this.onPaste.bind(this));
          	this.iBtnSend.addEventListener('click', this.saveMessages.bind(this));
          	this.aBackBtn.addEventListener('click', this.onBackBtnClick.bind(this));
          	this.aConfirmInvite.addEventListener('click', this.onConfirmInviteClick.bind(this));
          	this.iBtnAttach.addEventListener('click', this.onBtnAttachClick.bind(this));
          	this.attachFile.addEventListener('change', this.onAttachFile.bind(this));
          }

          /* 인증 환경 변화 */
          FirebaseChat.prototype.onAuthChange = function(user) {
          	if (user) {
          		console.log("User Login: ", JSON.stringify(user));
          		this.setLogin(user);
          	} else {
          		console.log("Logout");
          		this.setLogOut();
          	}
          }

          /* 이메일 로그인 버튼 클릭 */
          FirebaseChat.prototype.onEmailBtnClick = function() {
          	var email = document.getElementById('userName').value.trim(),
          		password = document.getElementById('password').value.trim();

          	if (FirebaseChat.emailCheck(email) && password.length > 0) {
          		var cbSignInEmail = function() {
          			return this.auth.signInWithEmailAndPassword(email, password)
          				.then(function() {
          					console.log("이메일 로그인 성공");
          				})
          				.catch(function(error) {
          					console.error("이메일 로그인 에러", error);
          					switch (error.code) {
          						case "auth/invalid-email":
          							alert("유효하지 않은 이메일입니다.");
          							break;
          						case "auth/user-disabled":
          							alert("정지된 계정입니다.");
          							break;
          						case "auth/user-not-found":
          							alert("사용자를 찾을 수 없습니다.");
          							break;
          						case "auth/wrong-password":
          							alert("잘못된 패스워드입니다.");
          							break;
          					}
          				});
          		}
          		this.auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
          			.then(cbSignInEmail.bind(this));
          	}
          }

          /* 로그인 후 */
          FirebaseChat.prototype.setLogin = function(user) {
          	this.database = firebase.database();
          	this.database.goOnline();
          	this.dvAuth.style.display = "none";
          	this.checkAndSaveUser(user);
          	this.loadUserList();
          	this.loadRoomList();
          	this.checkOnline();
          }

          /* 신규 사용자를 IndexedDB에서 체크 후 저장 */
          FirebaseChat.prototype.checkAndSaveUser = function(user) {
          	try {
          		var request = indexedDB.open(this.INDEXDB_DB_NAME, this.INDEXDB_VERSION),
          			objectname = this.INDEXDB_STORE;
          		request.onsuccess = function() {
          			var db = request.result;
          			var tx = db.transaction(objectname, "readwrite");
          			var store = tx.objectStore(objectname);

          			store.get(user.uid).onsuccess = function(event) {
          				var data = event.target.result;
          				console.log("IndexedDB query 결과: ", data);
          				console.log("checkAndSaveUser isSave = ", data.isSave);
          				if (!data.isSave) {
          					fbChat.saveUserAtRealDB(data);
          				}
          			}
          			tx.oncomplete = function() {
          				console.log("Successful IndexedDB transaction");
          				db.close();
          			};
          		}
          	} catch(e) {
          		this.saveUserAtRealDB(user);
          	}
          }

          /* 사용자 데이터를 IndexedDB에 저장, 데이터 변경 */
          FirebaseChat.prototype.saveUserAtIndexedDB = function(user, userName, isSave, pos) {
          	if (indexedDB) {
          		var request = indexedDB.open(this.INDEXDB_DB_NAME, this.INDEXDB_VERSION),
          			objectname = this.INDEXDB_STORE;
          		request.onupgradeneeded = function() {
          			var db = request.result,
          				store = db.createObjectStore(objectname, {keyPath: "uid"});
          		}
          		request.onsuccess = function() {
          			var db = request.result;
          			var tx = db.transaction(objectname, "readwrite");
          			// var tx = db.transaction(objectname, IDBTransaction.READ_WRITE);
          			var store = tx.objectStore(objectname);

          			store.get(user.uid).onsuccess = function(event) {
          				var data = event.target.result;
          				console.log("IndexedDB query result: ", data);
          				console.log("saveUserAtIndexedDB isSave = ", isSave);

          				if (!data) {
          					store.put({
          						uid: user.uid,
          						email: user.email,
          						photoURL: user.photoURL ? user.photoURL : "",
          						displayName: userName ? userName: user.displayName,
          						isSave: false,
          						position: pos
          					});
          				}

          				if (data && isSave) {
          					store.put({
          						uid: user.uid,
          						email: user.email,
          						photoURL: user.photoURL ? user.photoURL : "",
          						displayName: userName ? userName: user.displayName,
          						isSave: true,
          						position: pos
          					})
          				}
          			}
          			tx.oncomplete = function() {
          				console.log("Successful IndexedDB transaction");
          				db.close();
          			};
          		}
          		request.onerror = function(e) {
          			console.error(e.target.error.message);
          		}
          	}
          }

          /* Realtime DB에서 사용자 데이터를 체크 후 저장 */
          FirebaseChat.prototype.saveUserAtRealDB = function(user) {
          	var userRef = this.database.ref("Users/" + user.uid);
          	var cbUserRefResult = function(dataSnapShot) {
          		if (!dataSnapShot.hasChildren()) {
          			console.log("saveUserAtRealDB 저장");
          			userRef.set({
          				email: user.email,
          				profileImg: user.photoURL ? user.photoURL : "",
          				userName: user.displayName,
          				position: user.position
          			}).then(cbUserAfterSave.bind(this));
          		}
          	}
          	var cbUserAfterSave = function() {
          		if (user.position === "user") {
          			this.saveUserAtIndexedDB(user, null, true, "user");
          		} else {
          			this.saveUserAtIndexedDB(user, null, true, "admin");
          		}
          	}
          	userRef.once("value")
          		.then(cbUserRefResult.bind(this));
          }

          /* 온라인 여부 체크 */
          FirebaseChat.prototype.checkOnline = function() {
          	var userUid = this.auth.currentUser.uid,
          		myConnectionsRef = this.database.ref("UsersConnection/" + userUid + "/connection"),
          		lastOnlineRef = this.database.ref("UsersConnection/" + userUid + "/lastOnline"),
          		connectedRef = this.database.ref(".info/connected");

          	console.log("userUid: ", userUid);
          	connectedRef.on("value", function(snap) {
          		if (snap.val() === true) {
          			myConnectionsRef.set(true);
          			myConnectionsRef.onDisconnect().set(false);
          			lastOnlineRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
          		}
          	});
          	console.log("User Login Time: ", FirebaseChat.yyyyMMddHHmmsss());
          }

          /* 온라인 표시 활성화 */
          FirebaseChat.prototype.loadOnlineStatus = function() {
          	var usersConnectionRef = this.database.ref("UsersConnection");
          	usersConnectionRef.off();
          	var cbUserConnection = function(data) {
          		var connKey = data.key,
          			connValue = data.val(),
          			onlineIcon = document.querySelector("#li" + connKey + " .mood");
          		if (onlineIcon != null) {
          			if (connValue.connection === true) {
          				onlineIcon.classList.remove("hiddendiv");
          			} else {
          				onlineIcon.classList.add("hiddendiv");
          			}
          		}
          	}
          	usersConnectionRef.on("child_added", cbUserConnection.bind(this));
          	usersConnectionRef.on("child_changed", cbUserConnection.bind(this));
          }

          /* 사용자 리스트 호출 */
          FirebaseChat.prototype.loadUserList = function() {
          	this.userTemplate = document.getElementById("templateUserList").innerHTML;
          	var userRef = this.database.ref("Users");
          	userRef.off();
          	userRef.orderByChild("userName").once("value", this.getUserList.bind(this));
          	var cbCompleteUserList = function() {
          		this.loadOnlineStatus();
          	}
          	userRef.orderByChild("userName")
          		.once("value", this.getUserList.bind(this))
          		.then(cbCompleteUserList.bind(this));
          }

          /* loadUserList 후에 */
          FirebaseChat.prototype.getUserList = function(snapshot) {
          	var userListHtml = "";
          	var cbDisplayUserList = function(data) {
          		var val = data.val();
          		if (data.key !== this.auth.currentUser.uid) {
          			userListHtml += _.template(this.userTemplate)({
          				targetUserUid: data.key,
          				profileImg: val.profileImg,
          				userName: val.userName
          			});
          		}
          	}
          	snapshot.forEach(cbDisplayUserList.bind(this));
          	this.ulUserList.innerHTML = userListHtml;

          	// 리스트에서 사용자 클릭 시
          	var arrLiList = this.ulUserList.getElementsByTagName('li');
          	var arrLiListLength = arrLiList.length;
          	for (var i = 0; i < arrLiListLength; ++i) {
          		arrLiList[i].addEventListener('click', this.onUserListClick.bind(this));
          	}
          }

          /* 사용자 리스트 클릭 */
          FirebaseChat.prototype.onUserListClick = function(event) {
          	this.aBackBtn.classList.remove('hiddendiv');
          	this.aInvite.classList.remove('hiddendiv');
          	this.roomFlag = "tabUserList";

          	var targetUserUid = event.currentTarget.getAttribute("data-targetUserUid"),
          		targetUserName = event.currentTarget.getAttribute("data-username"),
          		roomListTarget = document.querySelectorAll('[data-roomType="' + this.ONE_VS_ONE + '"][data-roomOneVSOneTarget="' + targetUserUid + '"]')[0];

          	if (roomListTarget) {
          		roomListTarget.click();
          	} else {
          		this.roomTitle = targetUserName;
          		this.roomUserlist = [targetUserUid, this.auth.currentUser.uid];
          		this.roomUserName = [targetUserName, this.auth.currentUser.displayName];
          		this.roomId = this.MAKEID_CHAR + this.auth.currentUser.uid + this.DATETIME_CHAR + FirebaseChat.yyyyMMddHHmmsss();
          		this.openChatRoom(this.roomId, this.roomTitle);
          	}
          }

          /* 채팅방 오픈, 메시지 로드 및 AddUserList */
          FirebaseChat.prototype.openChatRoom = function(roomId, roomTitle) {
          	this.isOpenRoom = true;
          	if (roomTitle) {
          		this.spTitle.innerHTML = this.roomTitle;
          	}
          	this.loadMessageList(roomId);
          	this.tabMessageList.click();
          	this.setAddUserList();
          }

          /* 메세지 로드 */
          FirebaseChat.prototype.loadMessageList = function(roomId) {
          	if (roomId) {
          		this.ulMessageList.innerHTML = "";
          		var messageTemplate = document.getElementById("templateMessageList").innerHTML;
          		if (this.messageRef) {
          			this.messageRef.off();
          		}
          		this.messageRef = this.database.ref("Messages/" + roomId);
          		var cbDisplayMessages = function(data) {
          			var messageHtml = "";
          			var val = data.val();
          			messageHtml = _.template(messageTemplate)({
          				key: data.key,
          				profileImg: val.profileImg,
          				userName: val.userName,
          				time: FirebaseChat.timestampToTime(val.timestamp),
          				message: val.message
          			});
          			this.ulMessageList.innerHTML = this.ulMessageList.innerHTML + messageHtml;
          			this.ulMessageList.scrollTop = this.ulMessageList.scrollHeight;
          			this.roomTitle = val.roomTitle;
          		}
          		this.messageRef.limitToLast(50).on("child_added", cbDisplayMessages.bind(this));
          	}
          }

          /* 메세지 엔터 키 클릭 시 */
          FirebaseChat.prototype.onEnterKey = function(e) {
          	if (e.keyCode === 13) {
          		e.preventDefault();
          		this.saveMessages();
          	}
          }

          /* 메세지 전송 */
          FirebaseChat.prototype.saveMessages = function(inviteMessage, downloadURL, fileName) {
          	var user = this.auth.currentUser,
          		msg = this.dvInputChat.innerHTML.trim();

          	if (inviteMessage && inviteMessage.length > 0) {
          		msg = "<blockquote><strong><span class='red-text'> Notice: " + inviteMessage + "</span></strong></blockquote>";
          	}
          	if (downloadURL && fileName) {
          		msg = "<a class='waves-effect waves-light btn blue' download = '" + fileName + "'href='" + downloadURL + "'>다운로드</a></br><span class =''>파일명: "+ fileName + "</span>";
          	}
          	if (msg.length > 0) {
          		this.dvInputChat.focus();
          		this.dvInputChat.innerHTML = "";
          		var multiUpdates = {},
          			messageRefKey = this.messageRef.push().key,
          			convertMsg = (downloadURL || inviteMessage) ? msg : FirebaseChat.convertMsg(msg);

          		if (this.ulMessageList.getElementsByTagName('li').length === 0) {
          			var roomUserlistLength = this.roomUserlist.length;
          			for (var i = 0; i < roomUserlistLength; ++i) {
          				multiUpdates["RoomUsers/" + this.roomId + "/" + this.roomUserlist[i]] = true;
          			}
          			this.database.ref().update(multiUpdates);
          			this.loadMessageList(this.roomId);
          		}

          		multiUpdates = {};

          		// 메세지 저장
          		multiUpdates["Messages/" + this.roomId + "/" + messageRefKey] = {
          			uid: user.uid,
          			userName: user.displayName,
          			message: convertMsg,
          			profileImg: user.photoURL ? user.photoURL : "",
          			timestamp: firebase.database.ServerValue.TIMESTAMP
          		}

          		// 사용자 별 채팅방 리스트 저장
          		var roomUserListLength = this.roomUserlist.length;
          		if (this.roomUserlist && roomUserListLength > 0) {
          			for (var i = 0; i < roomUserListLength; ++i) {
          				multiUpdates["UserRooms/" + this.roomUserlist[i] + "/" + this.roomId] = {
          					roomId: this.roomId,
          					roomUserName: this.roomUserName.join(this.SPLIT_CHAR),
          					roomUserlist: this.roomUserlist.join(this.SPLIT_CHAR),
          					roomType: roomUserListLength > 2 ? this.MULTI : this.ONE_VS_ONE,
          					roomOneVSOneTarget: roomUserListLength == 2 && i == 0 ? this.roomUserlist[1] : roomUserListLength == 2 && i == 1 ? this.roomUserlist[0] : "",
          					lastMessage: downloadURL ? "다운로드" : convertMsg,
          					profileImg: user.photoURL ? user.photoURL : "",
          					timestamp: firebase.database.ServerValue.TIMESTAMP
          				};
          			}
          		}
          		this.database.ref().update(multiUpdates);
          	}
          }

          /* 메세지에 태그 입력 시 변경하기 */
          FirebaseChat.convertMsg = function(html) {
          	var tmp = document.createElement("DIV");
          	tmp.innerHTML = html;
          	return tmp.textContent || tmp.innerText || "";
          }

          /* 첨부파일 버튼 클릭 */
          FirebaseChat.prototype.onBtnAttachClick = function() {
          	this.attachFile.click();
          }

          /* 첨부파일 전송 */
          FirebaseChat.prototype.onAttachFile = function(event) {
          	$("#dnModal").modal("open");
          	var files = event.target.files,
          		filesLength = files.length,
          		progressBar = document.getElementById('dvProgressBar'),
          		fileName = files[0].name,
          		path = FirebaseChat.yyyyMMddHHmmsss().substr(0, 8) + "/" + this.roomId + "/" + this.auth.currentUser.uid + "/" + fileName,
          		uploadTask = firebase.storage().ref().child(path).put(files[0]);
          	var cbProgress = function(snapshot) {
          		var progress = (snapshot.bytesTransferred / snapshot.totalByters) * 100;
          		progressBar.style.width = progress + "%";
          	}

          	var cbError = function(error) {
          		console.log(error);
          		$("#dnModal").modal("close");
          		alert("업로드 중 에러가 발생하였습니다.");
          	}
          	var cbComplete = function() {
          		$("#dnModal").modal("close");
          		this.saveMessages(null, uploadTask.snapshot.downloadURL, fileName);
          		event.target.value = "";
          	}
          	uploadTask.on("state_changed", cbProgress.bind(this), cbError.bind(this), cbComplete.bind(this));
          }

          /* 사용자 초대 팝업 modal 창 세팅 */
          FirebaseChat.prototype.setAddUserList = function() {
          	this.ulAddUserList.innerHTML = this.ulUserList.innerHTML;
          	var arrAddUserList = Array.prototype.slice.call(this.ulAddUserList.getElementsByTagName('li'));
          	var cbArrayForEach = function(item) {
          		var itemUserUid = item.getAttribute("data-targetUserUid");
          		if (this.roomUserlist.indexOf(itemUserUid) === -1) {
          			item.getElementsByClassName("done")[0].classList.remove("hiddendiv");
          			item.addEventListener('click', function() {
          				if (Array.prototype.slice.call(this.classList).indexOf("blue-text") == -1) {
          					this.classList.add("blue-text");
          				} else {
          					this.classList.remove("blue-text");
          				}
          			});
          		} else {
          			item.parentNode.removeChild(item);
          		}
          	}
          	arrAddUserList.forEach(cbArrayForEach.bind(this));
          }

          /* 초대 */
          FirebaseChat.prototype.onConfirmInviteClick = function() {
          	var arrInviteUserList = Array.prototype.slice.call(this.ulAddUserList.getElementsByClassName("blue-text")),
          		arrInviteUserListLength = arrInviteUserList.length,
          		arrInviteUserName = [],
          		updates = {};
          	for (var i = 0; i < arrInviteUserListLength; ++i) {
          		var inviteUserUid = arrInviteUserList[i].getAttribute("data-targetUserUid"),
          			inviteUserName = arrInviteUserList[i].getAttribute("data-username");
          		updates["RoomUsers/" + this.roomId + "/" + inviteUserUid] = true;
          		arrInviteUserList[i].outerHTML = "";
          		this.roomUserlist.push(inviteUserUid);
          		this.roomUserName.push(inviteUserName);
          		arrInviteUserName.push(inviteUserName);
          	}
          	this.roomUserlist.sort();
          	this.database.ref().update(updates);
          	this.saveMessages(this.auth.currentUser.displayName + "님께서 " + arrInviteUserName.join() + "님을 초대했습니다.");
          }

          /* 채팅방 목록 출력 */
          FirebaseChat.prototype.loadRoomList = function() {
          	this.roomTemplate = document.getElementById("templateRoomList").innerHTML;
          	var roomRef = this.database.ref("UserRooms/" + this.auth.currentUser.uid);
          	roomRef.off();
          	roomRef.orderByChild("timestamp").on("value", this.getRoomList.bind(this));
          }

          /* loadRoomList 이후 */
          FirebaseChat.prototype.getRoomList = function(snapshot) {
          	var arrRoomListHtml = [];
          	var cbDisplayRoomList = function(data) {
          		var val = data.val();
          		var arrRoomUserName = val.roomUserName.split(this.SPLIT_CHAR);
          		arrRoomUserName.splice(arrRoomUserName.indexOf(this.auth.currentUser.displayName), 1);
          		var eachRoomTitle = arrRoomUserName.length > 1 ? arrRoomUserName[0] + " 외 " + (arrRoomUserName.length - 1) + "명" : arrRoomUserName[0];

          		if (data.key === this.roomId && this.isOpenRoom) {
          			this.spTitle.innerHTML = eachRoomTitle;
          		}

          		arrRoomListHtml.push(_.template(this.roomTemplate)({
          			roomId: data.key,
          			lastMessage: val.lastMessage,
          			profileImg: val.profileImg,
          			roomTitle: eachRoomTitle,
          			roomUserName: val.roomUserName,
          			roomUserlist: val.roomUserlist,
          			roomType: val.roomType,
          			roomOneVSOneTarget: val.roomOneVSOneTarget,
          			datetime: FirebaseChat.timestampToTimeForRoomList(val.timestamp)
          		}));
          	}
          	snapshot.forEach(cbDisplayRoomList.bind(this));
          	this.ulRoomList.innerHTML = arrRoomListHtml.reverse().join("");

          	// 채팅방 클릭 시
          	var arrLiList = this.ulRoomList.getElementsByTagName('li'),
          		arrLiListLength = arrLiList.length;
          	for (var i = 0; i < arrLiListLength; ++i) {
          		arrLiList[i].addEventListener('click', this.onRoomListClick.bind(this));
          	}
          }

          /* 채팅방 클릭 시 function */
          FirebaseChat.prototype.onRoomListClick = function(event) {
          	this.aBackBtn.classList.remove("hiddendiv");
          	this.aInvite.classList.remove("hiddendiv");
          	this.roomFlag = "tabRoomList";
          	this.roomId = event.currentTarget.getAttribute("data-roomId");
          	this.roomTitle = event.currentTarget.getAttribute("data-roomTitle");
          	this.roomUserlist = event.currentTarget.getAttribute("data-roomUserlist").split(this.SPLIT_CHAR);
          	this.roomUserName = event.currentTarget.getAttribute("data-roomUserName").split(this.SPLIT_CHAR);
          	this.openChatRoom(this.roomId, this.roomTitle);

          	this.tabMessageList.click();
          }

          /* 뒤로가기 버튼 클릭 */
          FirebaseChat.prototype.onBackBtnClick = function() {
          	this.isOpenRoom = false;
          	this.aBackBtn.classList.add("hiddendiv");
          	this.aInvite.classList.add("hiddendiv");
          	document.getElementById(this.roomFlag).click();
          	this.spTitle.innerText = this.ORIGIN_TITLE;
          	this.ulMessageList.innerHTML = "";
          }

          /* 채팅방 화면 시간 변경 */
          FirebaseChat.timestampToTimeForRoomList = function(timestamp) {
          	var date = new Date(timestamp),
          		year = date.getFullYear(),
          		month = date.getMonth() + 1,
          		day = date.getDate(),
          		hour = date.getHours(),
          		minute = date.getMinutes();
          	var nowDate = new Date(),
          		nowYear = nowDate.getFullYear(),
          		nowMonth = nowDate.getMonth() + 1,
          		nowDay = nowDate.getDate(),
          		nowHour = nowDate.getHours(),
          		nowMinute = nowDate.getMinutes();
          	var result;

          	if (year === nowYear && month === nowMonth && day === nowDay) {
          		result = FirebaseChat.pad(hour) + ":" + FirebaseChat.pad(minute);
          	} else {
          		result = FirebaseChat.pad(year) + "-" + FirebaseChat.pad(month) + "-" + FirebaseChat.pad(day);
          	}

          	return result;
          }

          /* 로그아웃 */
          FirebaseChat.prototype.logOut = function() {
          	if (confirm("로그아웃하시겠습니까?")) {
          		if (this.database) {
					this.database.goOffline();
          		}
          		this.auth.signOut();
          	}
          }

          /* 로그아웃되어 인증 환경 변화가 감지된 후 동작 */
          FirebaseChat.prototype.setLogOut = function() {
          	this.dvAuth.style.display = "block";
          	this.dvJoin.style.display = "none";
          	this.dvLogin.style.display = "block";
          	this.dvAdminJoin.style.display = "none";
          }

          /* 이메일 가입 양식 표시 */
          FirebaseChat.prototype.displayEmailJoin = function() {
          	this.dvLogin.style.display = "none";
          	this.dvJoin.style.display = "block";
          }

          var randomCode = "";
          /* 관리자 가입 양식 표시 */
          FirebaseChat.prototype.displayAdminEmailJoin = function() {
          	this.dvLogin.style.display = "none";
          	this.dvAdminJoin.style.display = "block";

          	var ar = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";			
			for(var i = 0; i < 6; i++) {
  				randomCode += ar.charAt(Math.floor(Math.random() * ar.length));
			}
			console.log(randomCode);
          }

          /* 이메일 가입 */
          FirebaseChat.prototype.createEmailUser = function() {
          	var userName = document.getElementById('joinUserName').value.trim(),
          		email = document.getElementById('joinUserEmail').value.trim(),
          		password = document.getElementById('joinPassword').value.trim(),
          		rePassword = document.getElementById('joinRePassword').value.trim();

          	if (this.validateJoinForm(email, password, rePassword)) {
          		var cbCreateUserWithEmail = function(user) {
          			console.log("사용자 가입 성공: ", JSON.stringify(user));
          			this.saveUserAtIndexedDB(user, userName, false, "user");

          			// 사용자 이름 파라미터 전달
          			user.updateProfile({
          				displayName: userName
          			}).then(function() {
          				console.log("사용자 이름 업데이트 성공");
          			}).catch(function(error) {
          				console.log("사용자 이름 업데이트 실패: ", error);
          			});
          		}
          		var cbAfterPersistence = function() {
          			return this.auth.createUserWithEmailAndPassword(email, password)
          				.then(cbCreateUserWithEmail.bind(this))
          				.catch(function(error) {
          					console.error("이메일 가입 중 에러: ", error);
          					switch (error.code) {
          						case "auth/email-already-in-use":
          							alert("이미 사용 중인 이메일입니다.");
          							break;
          						case "auth/invalid-email":
          							alert("유효하지 않은 이메일입니다.");
          							break;
          						case "auth/operation-not-allowed":
          							alert("이메일 가입이 중지되었습니다.");
          							break;
          						case "auth/weak-password":
          							alert("비밀번호는 6자리 이상이어야 합니다.");
          							break;
          					}
          				});
          		}

          		this.auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
          			.then(cbAfterPersistence.bind(this))
          			.catch(function(error) {
          				console.error("인증 환경 변경 중 에러 발생", error);
          			});
          	}
          }

          /* 관리자 가입 */
          FirebaseChat.prototype.createAdminEmailUser = function() {
          	var userName = document.getElementById('joinAdminName').value.trim(),
          		email = document.getElementById('joinAdminEmail').value.trim(),
          		password = document.getElementById('joinAdminPassword').value.trim(),
          		rePassword = document.getElementById('joinAdminRePassword').value.trim(),
          		adminCode = document.getElementById('joinAdminCode').value.trim();

          	if (this.validateJoinForm(email, password, rePassword) && this.validateAdminCode(adminCode)) {
          		randomCode = "";
          		var cbCreateAdminWithEmail = function(user) {
          			console.log("관리자 가입 성공: ", JSON.stringify(user));
          			this.saveUserAtIndexedDB(user, userName, false, "admin");

          			// 사용자 이름 파라미터 전달
          			user.updateProfile({
          				displayName: userName
          			}).then(function() {
          				console.log("관리자 이름 업데이트 성공");
          			}).catch(function(error) {
          				console.log("관리자 이름 업데이트 실패: ", error);
          			});
          		}
          		var cbAfterPersistence = function() {
          			return this.auth.createUserWithEmailAndPassword(email, password)
          				.then(cbCreateAdminWithEmail.bind(this))
          				.catch(function(error) {
          					console.error("이메일 가입 중 에러: ", error);
          					switch (error.code) {
          						case "auth/email-already-in-use":
          							alert("이미 사용 중인 이메일입니다.");
          							break;
          						case "auth/invalid-email":
          							alert("유효하지 않은 이메일입니다.");
          							break;
          						case "auth/operation-not-allowed":
          							alert("이메일 가입이 중지되었습니다.");
          							break;
          						case "auth/weak-password":
          							alert("비밀번호는 6자리 이상이어야 합니다.");
          							break;
          					}
          				});
          		}

          		this.auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
          			.then(cbAfterPersistence.bind(this))
          			.catch(function(error) {
          				console.error("인증 환경 변경 중 에러 발생", error);
          			});
          	}
          }

          /* 관리자 코드 발송 버튼 클릭 시 */
          FirebaseChat.prototype.sendAdminCode = function() {
			(function(){
          		var emailC = {
          			admin_number: randomCode
          		}

      			emailjs.init("user_wFCKDcC4dTTdHva3SFuJw");
      			emailjs.send("gmail", "template_NlXfnyOg", emailC)
      				.then(function(response) {
      					console.log("SUCCESS. status=%d, text=%s", response.status, response.text);
      				}, function(err) {
      					console.log("FAILED. error=", err);
      				});
   			})();
          }

          /* 이메일 유효성 체크 */
          FirebaseChat.prototype.validateJoinForm = function(email, password, rePassword) {
          	if (!FirebaseChat.emailCheck(email)) {
          		alert("이메일 형식에 맞지 않습니다.");
          		return false;
          	}
          	if (password !== rePassword) {
          		alert("패스워드가 동일하지 않습니다.");
          		return false;
          	}

          	return true;
          }

          /* 관리자 코드 유효성 체크 */
          FirebaseChat.prototype.validateAdminCode = function(adminCode) {
          	if (randomCode !== adminCode) {
          		alert("관리자 코드가 동일하지 않습니다.");
          		return false;
          	}

          	return true;
          }

          /* 이메일 형식 체크 */
          FirebaseChat.emailCheck = function(mail) {
          	if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(mail)) {
          		return true;
          	}

          	return false;
          }

          /* 현재 날짜를 yyyyMMddHHmmsss 형태로 반환 */
          FirebaseChat.yyyyMMddHHmmsss = function() {
          	var vDate = new Date(),
          		yyyy = vDate.getFullYear().toString(),
          		MM = (vDate.getMonth() + 1).toString(),
          		dd = vDate.getDate().toString(),
          		HH = vDate.getHours().toString(),
          		mm = vDate.getMinutes().toString(),
          		ss = vDate.getSeconds().toString(),
          		sss = vDate.getMilliseconds().toString();

          	return yyyy + (MM[1] ? MM : '0' + MM[0]) + (dd[1] ? dd : '0' + dd[0]) + (HH[1] ? HH : '0' + HH[0]) + (mm[1] ? mm : '0' + mm[0]) + (ss[1] ? ss : '0' + ss[0]) + sss;
          };

          /* timestamp를 날짜 시간으로 변환 */
          FirebaseChat.timestampToTime = function(timestamp) {
          	var date = new Date(timestamp),
          		year = date.getFullYear(),
          		month = date.getMonth() + 1,
          		day = date.getDate(),
          		hour = date.getHours(),
          		minute = date.getMinutes(),
          		week = new Array("일", "월", "화", "수", "목", "금", "토");
          	var convertDate = year + "년" + month + "월" + day + "일(" + week[date.getDay()] + ")",
          		convertHour = "";
          	if (hour < 12) {
          		convertHour = "오전 " + FirebaseChat.pad(hour) + ":" + FirebaseChat.pad(minute);
          	} else if (hour === 12) {
          		convertHour = "오후 " + FirebaseChat.pad(hour) + ":" + FirebaseChat.pad(minute);
          	} else {
          		convertHour = "오후 " + FirebaseChat.pad(hour - 12) + ":" + FirebaseChat.pad(minute);
          	}

          	return convertDate + convertHour;
          }

          /* 10 미만 숫자 처리 */
          FirebaseChat.pad = function(n) {
          	return n > 9 ? "" + n : "0" + n;
          }

          /* 복사 붙여넣기 시에 실행 */
          FirebaseChat.prototype.onPaste = function(e) {
          	e.preventDefault();
          	var text = e.clipboardData.getData("text/plain");
          	document.execCommand("insertText", false, text);
          }

          /* Dom 로딩 후 동작 */
          document.addEventListener('DOMContentLoaded', function() {
              // FirebaseChat 클래스 초기화
              window.fbChat = new FirebaseChat();

              // 다운로드 프로그레스 팝업 modal 설정
              $('#dnModal').modal();
              // 채팅방 초대 modal 설정
              $('#dvAddUser').modal();
          });
      </script>
  </body>
</html>
